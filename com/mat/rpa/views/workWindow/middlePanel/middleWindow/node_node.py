from com.mat.rpa.views.workWindow.middlePanel.directives.circle.forCircleDirective.forCircleDialog import \
    ForCircleDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.condition.directiveWidgets.ifConditionDirective.ifConditionObjectSettingDialog import \
    IfConditionObjectSettingDialog

from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.directiveWidgets.clickingWebElementDirective.clickingWebElementObjectSettingDialog import \
    ClickingWebElementObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.directiveWidgets.closingWebPageDirective.closingWebPageObjectSettingDialog import \
    ClosingWebPageObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.directiveWidgets.fillingInWebInputDirective.fillingInWebInputObjectSettingDialog import \
    FillingInWebInputObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.directiveWidgets.gettingOpenWebPageObjectDirective.getOpenPageObjectSettingDialog import \
    GetOpenPageObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.directiveWidgets.mouseHoveringOverWebElementDirective.mouseHoveringOverWebElementObjectSettingDialog import \
    MouseHoveringOverWebElementObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.directiveWidgets.openningWebPageDirective.openWebPageObjectSettingDialog import \
    OpenWebPageObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webDataRetrievingOperation.directiveWidgets.gettingAllFilteredCookiesDirective.gettingAllFilteredCookiesObjectSettingDialog import \
    GettingAllFilteredCookiesObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webDataRetrievingOperation.directiveWidgets.gettingScrollerPositionDirective.gettingScrollerPositionObjectSettingDialog import \
    GettingScrollerPositionObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webDataRetrievingOperation.directiveWidgets.gettingSpecifiedCookieInfoDirective.gettingSpecifiedCookieInfoObjectSettingDialog import \
    GettingSpecifiedCookieInfoObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webDataRetrievingOperation.directiveWidgets.gettingWebComboBoxOptionDirective.gettingWebComboBoxOptionObjectSettingDialog import \
    GettingWebComboBoxOptionObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webDataRetrievingOperation.directiveWidgets.gettingWebDialogContentDirective.gettingWebDialogContentObjectSettingDialog import \
    GettingWebDialogContentObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webDataRetrievingOperation.directiveWidgets.gettingWebElementInfoDirective.gettingWebElementInfoObjectSettingDialog import \
    GettingWebElementInfoObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webDataRetrievingOperation.directiveWidgets.gettingWebElementPositionDirective.gettingWebElementPositionObjectSettingDialog import \
    GettingWebElementPositionObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webDataRetrievingOperation.directiveWidgets.gettingWebPageInfoDirective.gettingWebPageInfoObjectSettingDialog import \
    GettingWebPageInfoObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webDataRetrievingOperation.directiveWidgets.gettingWebRequestResultDirective.gettingWebRequestResultObjectSettingDialog import \
    GettingWebRequestResultObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webDataRetrievingOperation.directiveWidgets.massDataGrabbingDirective.massDataGrabbingObjectSettingDialog import \
    MassDataGrabbingObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webDataRetrievingOperation.directiveWidgets.startingListeningWebRequestDirective.startingListeningWebRequestObjectSettingDialog import \
    StartingListeningWebRequestObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webDataRetrievingOperation.directiveWidgets.stoppingListeningWebRequestDirective.stoppingListeningWebRequestObjectSettingDialog import \
    StoppingListeningWebRequestObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webDataRetrievingOperation.directiveWidgets.webPageScreenshotDirective.webPageScreenshotObjectSettingDialog import \
    WebPageScreenshotObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webDialogOperation.directiveWidgets.downloadingFileDirective.downloadingFileObjectSettingDialog import DownloadingFileObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webElementOperation.directiveWidgets.draggingWebElementDirective.draggingWebElementObjectSettingDialog import \
    DraggingWebElementObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webElementOperation.directiveWidgets.fillingInPasswordWebInputDirective.fillingInPasswordWebInputObjectSettingDialog import \
    FillingInPasswordWebInputObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webElementOperation.directiveWidgets.gettingRelatedWebElementDirective.gettingRelatedWebElementObjectSettingDialog import \
    GettingRelatedWebElementObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webElementOperation.directiveWidgets.gettingSimilarWebElementListDirective.gettingSimilarWebElementListObjectSettingDialog import \
    GettingSimilarWebElementListObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webElementOperation.directiveWidgets.gettingWebElementObjectDirective.gettingWebElementObjectSettingDialog import \
    GettingWebElementObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webElementOperation.directiveWidgets.settingWebCheckBoxDirective.settingWebCheckBoxObjectSettingDialog import \
    SettingWebCheckBoxObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webElementOperation.directiveWidgets.settingWebComboboxDirective.settingWebComboboxObjectSettingDialog import \
    SettingWebComboboxObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webElementOperation.directiveWidgets.settingWebElementPropertyDirective.settingWebElementPropertyObjectSettingDialog import \
    SettingWebElementPropertyObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webElementOperation.directiveWidgets.settingWebElementValueDirective.settingWebElementValueObjectSettingDialog import \
    SettingWebElementValueObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webElementOperation.directiveWidgets.waitingForWebElementDirective.waitingForWebElementObjectSettingDialog import \
    WaitingForWebElementObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webPageOperation.directiveWidgets.mouseScrollingPageDirective.mouseScrollingPageObjectSettingDialog import \
    MouseScrollingPageObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webPageOperation.directiveWidgets.stoppingLoadingPageDirective.stoppingLoadingPageObjectSettingDialog import \
    StoppingLoadingPageObjectSettingDialog
from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webPageOperation.directiveWidgets.waitingForLoadingPageDirective.waitingForLoadingPageObjectSettingDialog import \
    WaitingForLoadingPageObjectSettingDialog

from com.mat.rpa.views.workWindow.middlePanel.directives.webAuto.webAutoConstants import WebAutoConstants
from com.mat.rpa.views.workWindow.middlePanel.middleWindow.node_graphics_node import QMGraphicsNode, QMGraphicsLozeNode, \
    QMGraphicsParaNode, QMGraphicsBeginNode
from com.mat.rpa.views.workWindow.middlePanel.middleWindow.node_socket import Socket, LEFT_TOP, RIGHT_BOTTON
from com.mat.rpa.views.workWindow.middlePanel.middleWindow.node_serializable import Serializable
from collections import OrderedDict

from com.mat.rpa.dao.workDao.directiveDao import DirectiveDao


class Node(Serializable):
    def __init__(self, scene, title="Undefined Node", type=" Node ", id=None, inputs=[], outputs=[]):
        super().__init__()
        self.scene = scene
        self.node_type = 1
        self.type = type
        self._title = title
        self.grNode = QMGraphicsNode(self)
        self.title = title
        self.scene.addNode(self)
        self.scene.grScene.addItem(self.grNode)
        self.inputs = []
        self.outputs = []
        self.socket_spacing = 22
        self.directiveDaoObj = DirectiveDao()
        # 流程编辑区域所对应的flow文件的id
        self.id = id
        self.directive = {"command": "",
                          "line_number": "",
                          "flow_title": "",
                          "data": {},
                          "comment": "",
                          "target": "",
                          "targets": [],
                          "value": ""
                          }
        # webAuto.directiveWidgets
        if self.type == "clickingWebElementDirective":  # 未添加
            self.directive["line_number"] = 1
            self.directive["command"] = WebAutoConstants.clickingWebElementDirective
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = ClickingWebElementObjectSettingDialog(self.title, self.directive["_id"], self.id)
            # 和上一个操作网页绑定
        if self.type == "closingWebPageDirective":
            self.directive["line_number"] = 1
            self.directive["command"] = WebAutoConstants.closingWebPageDirective
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = ClosingWebPageObjectSettingDialog(self.title, self.directive["_id"], self.id)
        if self.type == "fillingInWebInputDirective":
            self.directive["line_number"] = 1
            self.directive["command"] = WebAutoConstants.fillingInWebInputDirective
            self.directive["data"] = {"browser_type": 0,
                                      "element": "",
                                      "continue": False,
                                      "text": ""}
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = FillingInWebInputObjectSettingDialog(self.title, self.directive["_id"], self.id)
        if self.type == "gettingOpenWebPageObjectDirective":
            self.directive["line_number"] = 1
            self.directive["command"] = WebAutoConstants.gettingOpenWebPageObjectDirective
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = GetOpenPageObjectSettingDialog(self.title, self.directive["_id"], self.id)
        if self.type == "mouseHoveringOverWebElementDirective":
            self.directive["line_number"] = 1
            self.directive["command"] = WebAutoConstants.mouseHoveringOverWebElementDirective
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = MouseHoveringOverWebElementObjectSettingDialog(self.title, self.directive["_id"], self.id)
        if self.type == "openningWebPageDirective":
            self.directive["line_number"] = 1
            self.directive["command"] = WebAutoConstants.openningWebPageDirective
            self.directive["data"] = {"browser_type": 0,
                                      "url": "",
                                      "output": "web_page",
                                      "wait": True,
                                      "time_out_period": 15,
                                      "on_time_out": 0,
                                      "cli_parameter": "",
                                      "exe_path": "",
                                      "log": True,
                                      "handle": 0,
                                      "on_error_output_value": "",
                                      "retry_count": 1,
                                      "retry_interval": 1}
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = OpenWebPageObjectSettingDialog(self.title, self.directive["_id"], self.id)
        # webAuto.webDataRetrievingOperation
        if self.type == "gettingAllFilteredCookiesDirective":
            self.directive["line_number"] = 1
            self.directive["command"] = WebAutoConstants.webDataRetrievingContants.gettingAllFilteredCookiesDirective
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = GettingAllFilteredCookiesObjectSettingDialog(self.title, self.directive["_id"], self.id)
        if self.type == "gettingScrollerPositionDirective":
            self.directive["line_number"] = 1
            self.directive["command"] = WebAutoConstants.webDataRetrievingContants.gettingScrollerPositionDirective
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = GettingScrollerPositionObjectSettingDialog(self.title, self.directive["_id"], self.id)
        if self.type == "gettingSpecifiedCookieInfoDirective":
            self.directive["line_number"] = 1
            self.directive["command"] = WebAutoConstants.webDataRetrievingContants.gettingSpecifiedCookieInfoDirective
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = GettingSpecifiedCookieInfoObjectSettingDialog(self.title, self.directive["_id"], self.id)
        if self.type == "gettingWebComboBoxOption":
            self.directive["data"] = {"web_object": "",
                                      "element": "",
                                      "get_content": 0,
                                      "output": "select_items",
                                      "time_out": "20",
                                      "log": True,
                                      "handle": 0,
                                      "on_error_output_value": "",
                                      "retry_count": 1,
                                      "retry_interval": 1}
            self.directive["line_number"] = 1
            self.directive["command"] = WebAutoConstants.webDataRetrievingContants.gettingWebComboBoxOptionDirective
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = GettingWebComboBoxOptionObjectSettingDialog(self.title, self.directive["_id"], self.id)
        if self.type == "gettingWebDialogContentDirective":
            self.directive["line_number"] = 1
            self.directive["command"] = WebAutoConstants.webDataRetrievingContants.gettingWebDialogContentDirective
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = GettingWebDialogContentObjectSettingDialog(self.title, self.directive["_id"], self.id)
        if self.type == "gettingWebElementInfoDirective":
            self.directive["data"] = {"web_object": "",
                                      "element": "",
                                      "operation": 0,
                                      "intelligent_identification": False,
                                      "propert_name": "",
                                      "output": "web_element_attribute",
                                      "time_out": "20",
                                      "log": True,
                                      "handle": 0,
                                      "on_error_output_value": "",
                                      "retry_count": 1,
                                      "retry_interval": 1}
            self.directive["line_number"] = 1
            self.directive["command"] = WebAutoConstants.webDataRetrievingContants.gettingWebElementInfoDirective
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = GettingWebElementInfoObjectSettingDialog(self.title, self.directive["_id"], self.id)
        if self.type == "gettingWebElementPositionDirective":
            self.directive["data"] = {"web_object": "",
                                      "element": "",
                                      "relatively": 0,
                                      "output": "bound",
                                      "switch_dpi": True,
                                      "time_out": "20",
                                      "log": True,
                                      "handle": 0,
                                      "on_error_output_value": "",
                                      "retry_count": 1,
                                      "retry_interval": 1}
            self.directive["line_number"] = 1
            self.directive["command"] = WebAutoConstants.webDataRetrievingContants.gettingWebElementPositionDirective
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = GettingWebElementPositionObjectSettingDialog(self.title, self.directive["_id"], self.id)
        if self.type == "gettingWebPageInfoDirective":
            self.directive["data"] = {"web_object": "",
                                      "operation": 0,
                                      "output": "web_page_attribute",
                                      "log": True,
                                      "handle": 0,
                                      "on_error_output_value": "",
                                      "retry_count": 1,
                                      "retry_interval": 1}
            self.directive["line_number"] = 1
            self.directive["command"] = WebAutoConstants.webDataRetrievingContants.gettingWebPageInfoDirective
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = GettingWebPageInfoObjectSettingDialog(self.title, self.directive["_id"], self.id)
        if self.type == "gettingWebRequestResultDirective":
            self.directive["line_number"] = 1
            self.directive["command"] = WebAutoConstants.webDataRetrievingContants.gettingWebRequestResultDirective
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = GettingWebRequestResultObjectSettingDialog(self.title, self.directive["_id"], self.id)
        if self.type == "massDataGrabbingDirective":
            self.directive["line_number"] = 1
            self.directive["command"] = WebAutoConstants.webDataRetrievingContants.massDataGrabbingDirective
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = MassDataGrabbingObjectSettingDialog(self.title, self.directive["_id"], self.id)
        if self.type == "startingListeningWebRequestDirective":
            self.directive["line_number"] = 1
            self.directive["command"] = WebAutoConstants.webDataRetrievingContants.startingListeningWebRequestDirective
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = StartingListeningWebRequestObjectSettingDialog(self.title, self.directive["_id"], self.id)
        if self.type == "stoppingListeningWebRequestDirective":
            self.directive["line_number"] = 1
            self.directive["command"] = WebAutoConstants.webDataRetrievingContants.stoppingListeningWebRequestDirective
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = StoppingListeningWebRequestObjectSettingDialog(self.title, self.directive["_id"], self.id)
        if self.type == "webPageScreenshotDirective":
            self.directive["data"] = {"web_object": "",
                                      "screenshot_area": 0,
                                      "element_name": "",
                                      "save_location": False,
                                      "save_location_name": "",
                                      "name": True,
                                      "custom_name": "",
                                      "name_way": True,
                                      "output": "screenshot_save_file_name",
                                      "time_out_period": "20",
                                      "log": True,
                                      "handle": 0,
                                      "on_error_output_value": "",
                                      "retry_count": 1,
                                      "retry_interval": 1}
            self.directive["line_number"] = 1
            self.directive["command"] = WebAutoConstants.webDataRetrievingContants.webPageScreenshotDirective
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = WebPageScreenshotObjectSettingDialog(self.title, self.directive["_id"], self.id)
            if self.type == "downloadingFileDirective":
                self.directive["data"] = {"web_object": "",
                                          "screenshot_area": 0,
                                          "element_name": "",
                                          "save_location": False,
                                          "save_location_name": "",
                                          "name": True,
                                          "custom_name": "",
                                          "name_way": True,
                                          "output": "screenshot_save_file_name",
                                          "time_out_period": "20",
                                          "log": True,
                                          "handle": 0,
                                          "on_error_output_value": "",
                                          "retry_count": 1,
                                          "retry_interval": 1}
                self.directive["line_number"] = 1
                self.directive["command"] = WebAutoConstants.webDialogContants.downloadingFileDirective
                self.directive["flow_id"] = self.id
                self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
                self.dialog = DownloadingFileObjectSettingDialog(self.title, self.directive["_id"], self.id)
        # web元素操作
        if self.type == "draggingWebElementDirective":
            self.directive["line_number"] = 1
            self.directive["command"] = "draggingWebElementDirective"
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = DraggingWebElementObjectSettingDialog(self.title, self.directive["_id"], self.id)
        if self.type == "waitingForWebElementDirective":
            self.directive["data"] = {"browser_type": 0,
                                      "element": "",
                                      "method": 0,
                                      "value": ""}
            self.directive["line_number"] = 1
            self.directive["command"] = "waitingForWebElementDirective"
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = WaitingForWebElementObjectSettingDialog(self.title, self.directive["_id"], self.id)
        if self.type == "fillingInPasswordWebInputDirective":
            self.directive["data"] = {"browser_type": 0,
                                      "element": ""}
            self.directive["line_number"] = 1
            self.directive["command"] = "fillingInPasswordWebInputDirective"
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = FillingInPasswordWebInputObjectSettingDialog(self.title, self.directive["_id"], self.id)
        if self.type == "settingWebComboboxDirective":
            self.directive["data"] = {"browser_type": 0,
                                      "object": 0,
                                      "element": "",
                                      "value": ""}
            self.directive["line_number"] = 1
            self.directive["command"] = "settingWebComboboxDirective"
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = SettingWebComboboxObjectSettingDialog(self.title, self.directive["_id"], self.id)
        if self.type == "settingWebCheckBoxDirective":
            self.directive["data"] = {"browser_type": 0,
                                      "object": 0,
                                      "element": ""}
            self.directive["line_number"] = 1
            self.directive["command"] = "settingWebCheckBoxDirective"
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = SettingWebCheckBoxObjectSettingDialog(self.title, self.directive["_id"], self.id)
        if self.type == "settingWebElementValueDirective":
            self.directive["data"] = {"browser_type": 0,
                                      "element": "",
                                      "value": ""}
            self.directive["line_number"] = 1
            self.directive["command"] = "settingWebElementValueDirective"
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = SettingWebElementValueObjectSettingDialog(self.title, self.directive["_id"], self.id)
        if self.type == "settingWebElementPropertyDirective":
            self.directive["data"] = {"browser_type": 0,
                                      "element": "",
                                      "name": "",
                                      "value": ""}
            self.directive["line_number"] = 1
            self.directive["command"] = "settingWebElementPropertyDirective"
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = SettingWebElementPropertyObjectSettingDialog(self.title, self.directive["_id"], self.id)
        if self.type == "gettingWebElementObjectDirective":
            self.directive["data"] = {"browser_type": 0,
                                      "element": "",
                                      "value": False}
            self.directive["line_number"] = 1
            self.directive["command"] = "gettingWebElementObjectDirective"
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = GettingWebElementObjectSettingDialog(self.title, self.directive["_id"], self.id)
        if self.type == "gettingRelatedWebElementDirective":
            self.directive["line_number"] = 1
            self.directive["command"] = "gettingRelatedWebElementDirective"
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = GettingRelatedWebElementObjectSettingDialog(self.title, self.directive["_id"], self.id)
        if self.type == "gettingSimilarWebElementListDirective":
            self.directive["line_number"] = 1
            self.directive["command"] = "gettingSimilarWebElementListDirective"
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = GettingSimilarWebElementListObjectSettingDialog(self.title, self.directive["_id"], self.id)
        # web页面操作
        if self.type == "waitingForLoadingPageDirective":
            self.directive["data"] = {"web_object": "",
                                      "time_out": "20",
                                      "execute_error": 0,
                                      "log": True,
                                      "handle": 0,
                                      "retry_count": 1,
                                      "retry_interval": 1}
            self.directive["line_number"] = 1
            self.directive["command"] = "waitingForLoadingPageDirective"
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = WaitingForLoadingPageObjectSettingDialog(self.title, self.directive["_id"], self.id)
        if self.type == "stoppingLoadingPageDirective":
            self.directive["data"] = {"web_object": "",
                                      "log": True,
                                      "handle": 0,
                                      "retry_count": 1,
                                      "retry_interval": 1}
            self.directive["line_number"] = 1
            self.directive["command"] = "stoppingLoadingPageDirective"
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = StoppingLoadingPageObjectSettingDialog(self.title, self.directive["_id"], self.id)
        if self.type == "mouseScrollingPageDirective":
            self.directive["data"] = {"web_object": "",
                                      "scroll_range": False,
                                      "element": "",
                                      "element_scroller": False,
                                      "scroller_position": 0,
                                      "abscissa": "0",
                                      "ordinate": "0",
                                      "scroller_effect": 0,
                                      "time_out": "20",
                                      "log": True,
                                      "handle": 0,
                                      "retry_count": 1,
                                      "retry_interval": 1}
            self.directive["line_number"] = 1
            self.directive["command"] = "mouseScrollingPageDirective"
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = MouseScrollingPageObjectSettingDialog(self.title, self.directive["_id"], self.id)

        # 未完成
        # webAuto.webElementOperation   0/10
        # webAuto.webPageOperation    0/8
        # 数据处理.产生变量         1/1

        # self.updateDirectiveData2DB(self.directive["_id"], self.directive["data"])
        # self.data = self.getDirectiveSettingDataFromDB(self.directive["_id"])

        # crate socket for inputs and outputs
        counter = 1
        for item in inputs:
            socket = Socket(node=self, index=counter, position=LEFT_TOP)
            counter += 1
            self.inputs.append(socket)

        counter = 1
        for item in outputs:
            socket = Socket(node=self, index=counter, position=RIGHT_BOTTON)
            counter += 1
            self.outputs.append(socket)

    def getNextNode(self):
        for edge in self.scene.edges:
            if edge.start_socket is not None and edge.end_socket is not None:
                if edge.start_socket.node == self:
                    return edge.end_socket.node
        return None

    def updateDirectiveData2DB(self, directive_id, data: dict):
        self.directiveDaoObj.updateDirective(directive_id, {"data": data})

    # 从数据库中读取指令设置
    def getDirectiveSettingDataFromDB(self, directive_id):
        return self.directiveDaoObj.getOneDirective(directive_id)["data"]

    def getSocketPosition(self, index, position):
        if index == 4:
            x = 0
            y = self.grNode.height / 2
        elif index == 2:
            x = self.grNode.width
            y = self.grNode.height / 2
        elif index == 1:
            x = self.grNode.width / 2
            y = 0
        elif index == 3:
            x = self.grNode.width / 2
            y = self.grNode.height
        return [x, y]

    @property
    def pos(self):
        return self.grNode.pos()

    def setPos(self, x, y):
        self.grNode.setPos(x, y)

    def setNode_Type(self, a):
        self.node_type = a

    def updateConnectedEdges(self):
        for socket in self.inputs + self.outputs:
            if socket.hasEdge():
                socket.edge.updatePosition()

    def updateConnectedSockets(self):
        for socket in self.inputs + self.outputs:
            socket.update()

    def remove(self):
        for socket in (self.inputs + self.outputs):
            if socket.hasEdge():
                socket.edge.remove()
        self.scene.grScene.removeItem(self.grNode)
        self.grNode = None
        self.scene.removeNode(self)

    def serialize(self):
        inputs, outputs = [], []
        for socket in self.inputs:
            inputs.append(socket.serialize())
        for socket in self.outputs:
            outputs.append(socket.serialize())
        dialog = self.dialog.serialize()
        return OrderedDict([
            ('id', self.id),
            ('title', self.title),
            ('node_type', self.node_type),
            ('type', self.type),
            ('pos_x', self.grNode.scenePos().x()),
            ('pos_y', self.grNode.scenePos().y()),
            ('inputs', inputs),
            ('outputs', outputs),
            ('dialog', dialog)
        ])

    def deserialize(self, data, hashmap={}):

        self.id = data['id']
        self.node_type = data['node_type']
        hashmap[data['id']] = self
        self.type = data['type']
        self.setPos(data['pos_x'], data['pos_y'])
        self.title = data['title']

        data['inputs'].sort(key=lambda socket: socket['index'] + socket['position'] * 1000)
        data['outputs'].sort(key=lambda socket: socket['index'] + socket['position'] * 1000)
        self.inputs = []
        for socket_data in data['inputs']:
            new_socket = Socket(node=self, index=socket_data['index'], position=socket_data['position'],
                                socket_type=socket_data['socket_type'])

            new_socket.deserialize(socket_data, hashmap)
            self.inputs.append(new_socket)

        self.outputs = []
        for socket_data in data['outputs']:
            new_socket = Socket(node=self, index=socket_data['index'], position=socket_data['position'],
                                socket_type=socket_data['socket_type'])

            new_socket.deserialize(socket_data, hashmap)
            self.outputs.append(new_socket)
        self.setDialog(data['dialog'])

        return True

    @property
    def title(self):
        return self._title

    @title.setter
    def title(self, value):
        self._title = value
        self.grNode.title = self._title

    def setDialog(self, data):
        if self.type == "openningWebPageDirective":
            self.directive["line_number"] = 1
            self.directive["command"] = WebAutoConstants.openningWebPageDirective
            self.directive["data"] = {"browser_type": 0,
                                      "url": "",
                                      "output": "web_page",
                                      "wait": True,
                                      "time_out_period": 15,
                                      "on_time_out": 0,
                                      "cli_parameter": "",
                                      "exe_path": "",
                                      "log": True,
                                      "handle": 0,
                                      "on_error_output_value": "",
                                      "retry_count": 1,
                                      "retry_interval": 1}
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = OpenWebPageObjectSettingDialog(self.title, self.directive["_id"], self.id)
            self.dialog.deserialize(data)

        if self.type == "clickingWebElementDirective":  # 未添加
            self.directive["line_number"] = 1
            self.directive["command"] = WebAutoConstants.clickingWebElementDirective
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = ClickingWebElementObjectSettingDialog(self.title, self.directive["_id"], self.id)
            self.dialog.deserialize(data)

        if self.type == "closingWebPageDirective":
            self.directive["line_number"] = 1
            self.directive["command"] = WebAutoConstants.closingWebPageDirective
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = ClosingWebPageObjectSettingDialog(self.title, self.directive["_id"], self.id)
            self.dialog.deserialize(data)

        if self.type == "fillingInWebInputDirective":
            self.directive["line_number"] = 1
            self.directive["command"] = WebAutoConstants.fillingInWebInputDirective
            self.directive["data"] = {"browser_type": 0,
                                      "element": "",
                                      "continue": False,
                                      "text": ""}
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = FillingInWebInputObjectSettingDialog(self.title, self.directive["_id"], self.id)
            self.dialog.deserialize(data)

        if self.type == "gettingOpenWebPageObjectDirective":
            self.directive["line_number"] = 1
            self.directive["command"] = WebAutoConstants.gettingOpenWebPageObjectDirective
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = GetOpenPageObjectSettingDialog(self.title, self.directive["_id"], self.id)
            self.dialog.deserialize(data)

        if self.type == "mouseHoveringOverWebElementDirective":
            self.directive["line_number"] = 1
            self.directive["command"] = WebAutoConstants.mouseHoveringOverWebElementDirective
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = MouseHoveringOverWebElementObjectSettingDialog(self.title, self.directive["_id"], self.id)
            self.dialog.deserialize(data)


class LozeNode(Serializable):
    def __init__(self, scene, title="Undefined Node", type="Node", id=None, inputs=[], outputs=[]):
        super().__init__()
        self.scene = scene
        self.node_type = 2
        self._title = title
        self.type = type
        self.grNode = QMGraphicsLozeNode(self)
        self.title = title
        self.scene.addNode(self)
        self.scene.grScene.addItem(self.grNode)
        self.inputs = []
        self.outputs = []
        self.socket_spacing = 22
        # crate socket for inputs and outputs
        self.directiveDaoObj = DirectiveDao()
        self.id = id
        self.directive = {"command": "",
                          "line_number": "",
                          "flow_title": "",
                          "data": {},
                          "comment": "",
                          "target": "",
                          "targets": [],
                          "value": ""
                          }

        if self.type == "ifConditionDirective":
            self.directive["line_number"] = 1
            self.directive["command"] = "ifConditionDirective"
            self.directive["flow_id"] = self.id
            self.directive["data"] = {"obj1": "",
                                      "relation": "等于",
                                      "obj2": ""}
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = IfConditionObjectSettingDialog(self.title, self.directive["_id"], self.id)

        counter = 1
        for item in inputs:
            socket = Socket(node=self, index=counter, position=LEFT_TOP)
            counter += 1
            self.inputs.append(socket)

        counter = 1
        for item in outputs:
            socket = Socket(node=self, index=counter, position=RIGHT_BOTTON)
            counter += 1
            self.outputs.append(socket)

    def getNextNode(self):
        for edge in self.scene.edges:
            if edge.start_socket is not None and edge.end_socket is not None:
                if edge.start_socket.node == self and edge.start_socket.index == self.dialog.answer:
                    return edge.end_socket.node
        return None

    def updateDirectiveData2DB(self, directive_id, data: dict):
        self.directiveDaoObj.updateDirective(directive_id, {"data": data})

        # 从数据库中读取指令设置

    def getDirectiveSettingDataFromDB(self, directive_id):
        return self.directiveDaoObj.getOneDirective(directive_id)["data"]

    def getSocketPosition(self, index, position):
        if index == 4:
            x = 0
            y = self.grNode.height / 2
        elif index == 2:
            x = self.grNode.width
            y = self.grNode.height / 2
        elif index == 1:
            x = self.grNode.width / 2
            y = 0
        elif index == 3:
            x = self.grNode.width / 2
            y = self.grNode.height
        return [x, y]

    @property
    def pos(self):
        return self.grNode.pos()

    def setPos(self, x, y):
        self.grNode.setPos(x, y)

    def updateConnectedEdges(self):
        for socket in self.inputs + self.outputs:
            if socket.hasEdge():
                socket.edge.updatePosition()

    def updateConnectedSockets(self):
        for socket in self.inputs + self.outputs:
            socket.update()

    def remove(self):
        for socket in (self.inputs + self.outputs):
            if socket.hasEdge():
                socket.edge.remove()
        self.scene.grScene.removeItem(self.grNode)
        self.grNode = None
        self.scene.removeNode(self)

    def serialize(self):
        inputs, outputs = [], []
        for socket in self.inputs:
            inputs.append(socket.serialize())
        for socket in self.outputs:
            outputs.append(socket.serialize())
        dialog = self.dialog.serialize()
        return OrderedDict([
            ('id', self.id),
            ('title', self.title),
            ('node_type', self.node_type),
            ('type', self.type),
            ('pos_x', self.grNode.scenePos().x()),
            ('pos_y', self.grNode.scenePos().y()),
            ('inputs', inputs),
            ('outputs', outputs),
            ('dialog', dialog),
        ])

    def deserialize(self, data, hashmap={}):

        self.id = data['id']
        self.node_type = data['node_type']
        hashmap[data['id']] = self
        self.type = data['type']
        self.setPos(data['pos_x'], data['pos_y'])
        self.title = data['title']

        data['inputs'].sort(key=lambda socket: socket['index'] + socket['position'] * 1000)
        data['outputs'].sort(key=lambda socket: socket['index'] + socket['position'] * 1000)
        self.inputs = []
        for socket_data in data['inputs']:
            new_socket = Socket(node=self, index=socket_data['index'], position=socket_data['position'],
                                socket_type=socket_data['socket_type'])

            new_socket.deserialize(socket_data, hashmap)
            self.inputs.append(new_socket)

        self.outputs = []
        for socket_data in data['outputs']:
            new_socket = Socket(node=self, index=socket_data['index'], position=socket_data['position'],
                                socket_type=socket_data['socket_type'])

            new_socket.deserialize(socket_data, hashmap)
            self.outputs.append(new_socket)

        self.setDialog(data['dialog'])

        return True

    @property
    def title(self):
        return self._title

    @title.setter
    def title(self, value):
        self._title = value
        self.grNode.title = self._title

    def setDialog(self, data):
        if self.type == "ifConditionDirective":
            self.directive["line_number"] = 1
            self.directive["command"] = "ifConditionDirective"
            self.directive["flow_id"] = self.id
            self.directive["data"] = {"obj1": "",
                                      "relation": "等于",
                                      "obj2": ""}
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = IfConditionObjectSettingDialog(self.title, self.directive["_id"], self.id)
            self.dialog.deserialize(data)


class ParaNode(Serializable):
    def __init__(self, scene, title="Undefined Node", type=" Node ", id=None, inputs=[], outputs=[]):
        super().__init__()
        self.scene = scene
        self.id = id
        self.node_type = 3
        self.type = type
        self._title = title

        self.grNode = QMGraphicsParaNode(self)
        self.title = title
        self.scene.addNode(self)
        self.scene.grScene.addItem(self.grNode)

        self.inputs = []
        self.outputs = []
        self.socket_spacing = 22
        self.directiveDaoObj = DirectiveDao()
        self.directive = {
            "command": "",
            "line_number": "",
            "flow_title": "",
            "data": {},
            "comment": "",
            "target": "",
            "targets": [],
            "value": ""
        }

        if self.type == "forCircleDirective":
            self.directive["data"] = {"obj1": "",
                                      "obj2": "",
                                      "relation": "小于",
                                      "obj3": ""}
            self.directive["line_number"] = 1
            self.directive["command"] = "forCircleDirective"
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = ForCircleDialog(self.title, self.directive["_id"], self.id)

        # crate socket for inputs and outputs
        counter = 1
        for item in inputs:
            socket = Socket(node=self, index=counter, position=LEFT_TOP)
            counter += 1
            self.inputs.append(socket)

        counter = 1
        for item in outputs:
            socket = Socket(node=self, index=counter, position=RIGHT_BOTTON)
            counter += 1
            self.outputs.append(socket)

    def getNextNode(self):
        for edge in self.scene.edges:
            if edge.start_socket is not None and edge.end_socket is not None:
                if edge.start_socket.node == self and edge.start_socket.index == self.dialog.answer:
                    return edge.end_socket.node
        return None

    def updateDirectiveData2DB(self, directive_id, data: dict):
        self.directiveDaoObj.updateDirective(directive_id, {"data": data})

    def getDirectiveSettingDataFromDB(self, directive_id):
        return self.directiveDaoObj.getOneDirective(directive_id)["data"]

    def getSocketPosition(self, index, position):
        if index == 4:
            x = 0
            y = self.grNode.height / 2
        elif index == 2:
            x = self.grNode.width
            y = self.grNode.height / 2
        elif index == 1:
            x = self.grNode.width / 2
            y = 0
        elif index == 3:
            x = self.grNode.width / 2
            y = self.grNode.height
        return [x, y]

    @property
    def pos(self):
        return self.grNode.pos()

    def setPos(self, x, y):
        self.grNode.setPos(x, y)

    def updateConnectedEdges(self):
        for socket in self.inputs + self.outputs:
            if socket.hasEdge():
                socket.edge.updatePosition()

    def updateConnectedSockets(self):
        for socket in self.inputs + self.outputs:
            socket.update()

    def remove(self):
        for socket in (self.inputs + self.outputs):
            if socket.hasEdge():
                socket.edge.remove()
        self.scene.grScene.removeItem(self.grNode)
        self.grNode = None
        self.scene.removeNode(self)

    def serialize(self):
        inputs, outputs = [], []
        for socket in self.inputs:
            inputs.append(socket.serialize())
        for socket in self.outputs:
            outputs.append(socket.serialize())
        dialog = self.dialog.serialize()
        return OrderedDict([
            ('id', self.id),
            ('title', self.title),
            ('node_type', self.node_type),
            ('type', self.type),
            ('pos_x', self.grNode.scenePos().x()),
            ('pos_y', self.grNode.scenePos().y()),
            ('inputs', inputs),
            ('outputs', outputs),
            ('dialog', dialog)
        ])

    def deserialize(self, data, hashmap={}):

        self.id = data['id']
        self.node_type = data['node_type']
        hashmap[data['id']] = self
        self.type = data['type']
        self.setPos(data['pos_x'], data['pos_y'])
        self.title = data['title']

        data['inputs'].sort(key=lambda socket: socket['index'] + socket['position'] * 1000)
        data['outputs'].sort(key=lambda socket: socket['index'] + socket['position'] * 1000)
        self.inputs = []
        for socket_data in data['inputs']:
            new_socket = Socket(node=self, index=socket_data['index'], position=socket_data['position'],
                                socket_type=socket_data['socket_type'])

            new_socket.deserialize(socket_data, hashmap)
            self.inputs.append(new_socket)

        self.outputs = []
        for socket_data in data['outputs']:
            new_socket = Socket(node=self, index=socket_data['index'], position=socket_data['position'],
                                socket_type=socket_data['socket_type'])

            new_socket.deserialize(socket_data, hashmap)
            self.outputs.append(new_socket)
        self.setDialog(data['dialog'])
        return True

    @property
    def title(self):
        return self._title

    @title.setter
    def title(self, value):
        self._title = value
        self.grNode.title = self._title

    def setDialog(self, data):
        if self.type == "forCircleDirective":
            self.directive["data"] = {"obj1": "",
                                      "obj2": "",
                                      "relation": "小于",
                                      "obj3": ""}
            self.directive["line_number"] = 1
            self.directive["command"] = "forCircleDirective"
            self.directive["flow_id"] = self.id
            self.directive["_id"] = self.directiveDaoObj.insertDirective(self.directive)
            self.dialog = ForCircleDialog(self.title, self.directive["_id"], self.id)
            self.dialog.deserialize(data)


class BeginNode(Serializable):
    def __init__(self, scene, title="Undefined Node", type=" Node ", id=None, inputs=[], outputs=[]):
        super().__init__()
        self.scene = scene
        self.id = id
        self.node_type = 4
        self.type = type
        self._title = title

        self.grNode = QMGraphicsBeginNode(self)
        self.title = title
        self.scene.addNode(self)
        self.scene.grScene.addItem(self.grNode)

        self.inputs = []
        self.outputs = []
        self.socket_spacing = 22
        # crate socket for inputs and outputs
        counter = 3
        for item in inputs:
            socket = Socket(node=self, index=counter, position=LEFT_TOP)
            counter += 1
            self.inputs.append(socket)

        counter = 1
        for item in outputs:
            socket = Socket(node=self, index=counter, position=RIGHT_BOTTON)
            counter += 1
            self.outputs.append(socket)

    def getNextNode(self):
        for edge in self.scene.edges:
            if edge.start_socket is not None and edge.end_socket is not None:
                if edge.start_socket.node == self:
                    return edge.end_socket.node
        return None

    def getSocketPosition(self, index, position):
        if index == 4:
            x = 0
            y = self.grNode.height / 2
        elif index == 2:
            x = self.grNode.width
            y = self.grNode.height / 2
        elif index == 1:
            x = self.grNode.width / 2
            y = 0
        elif index == 3:
            x = self.grNode.width / 2
            y = self.grNode.height
        return [x, y]

    @property
    def pos(self):
        return self.grNode.pos()

    def setPos(self, x, y):
        self.grNode.setPos(x, y)

    def updateConnectedEdges(self):
        for socket in self.inputs + self.outputs:
            if socket.hasEdge():
                socket.edge.updatePosition()

    def updateConnectedSockets(self):
        for socket in self.inputs + self.outputs:
            socket.update()

    def remove(self):
        for socket in (self.inputs + self.outputs):
            if socket.hasEdge():
                socket.edge.remove()
        self.scene.grScene.removeItem(self.grNode)
        self.grNode = None
        self.scene.removeNode(self)

    def serialize(self):
        inputs, outputs = [], []
        for socket in self.inputs:
            inputs.append(socket.serialize())
        for socket in self.outputs:
            outputs.append(socket.serialize())
        return OrderedDict([
            ('id', self.id),
            ('title', self.title),
            ('node_type', self.node_type),
            ('type', self.type),
            ('pos_x', self.grNode.scenePos().x()),
            ('pos_y', self.grNode.scenePos().y()),
            ('inputs', inputs),
            ('outputs', outputs),
        ])

    def deserialize(self, data, hashmap={}):

        self.id = data['id']
        self.node_type = data['node_type']
        hashmap[data['id']] = self
        self.type = data['type']
        self.setPos(data['pos_x'], data['pos_y'])
        self.title = data['title']

        data['inputs'].sort(key=lambda socket: socket['index'] + socket['position'] * 1000)
        data['outputs'].sort(key=lambda socket: socket['index'] + socket['position'] * 1000)
        self.inputs = []
        for socket_data in data['inputs']:
            new_socket = Socket(node=self, index=socket_data['index'], position=socket_data['position'],
                                socket_type=socket_data['socket_type'])

            new_socket.deserialize(socket_data, hashmap)
            self.inputs.append(new_socket)

        self.outputs = []
        for socket_data in data['outputs']:
            new_socket = Socket(node=self, index=socket_data['index'], position=socket_data['position'],
                                socket_type=socket_data['socket_type'])

            new_socket.deserialize(socket_data, hashmap)
            self.outputs.append(new_socket)
        return True

    @property
    def title(self):
        return self._title

    @title.setter
    def title(self, value):
        self._title = value
        self.grNode.title = self._title


class EndNode(Serializable):
    def __init__(self, scene, title="Undefined Node", type=" Node ", id=None, inputs=[], outputs=[]):
        super().__init__()
        self.scene = scene
        self.id = id
        self.node_type = 5
        self.type = type
        self._title = title

        self.grNode = QMGraphicsBeginNode(self)
        self.title = title
        self.scene.addNode(self)
        self.scene.grScene.addItem(self.grNode)

        self.inputs = []
        self.outputs = []
        self.socket_spacing = 22
        # crate socket for inputs and outputs
        counter = 1
        for item in inputs:
            socket = Socket(node=self, index=counter, position=LEFT_TOP)
            counter += 1
            self.inputs.append(socket)

        counter = 1
        for item in outputs:
            socket = Socket(node=self, index=counter, position=RIGHT_BOTTON)
            counter += 1
            self.outputs.append(socket)

    def getSocketPosition(self, index, position):
        if index == 4:
            x = 0
            y = self.grNode.height / 2
        elif index == 2:
            x = self.grNode.width
            y = self.grNode.height / 2
        elif index == 1:
            x = self.grNode.width / 2
            y = 0
        elif index == 3:
            x = self.grNode.width / 2
            y = self.grNode.height
        return [x, y]

    @property
    def pos(self):
        return self.grNode.pos()

    def setPos(self, x, y):
        self.grNode.setPos(x, y)

    def updateConnectedEdges(self):
        for socket in self.inputs + self.outputs:
            if socket.hasEdge():
                socket.edge.updatePosition()

    def updateConnectedSockets(self):
        for socket in self.inputs + self.outputs:
            socket.update()

    def remove(self):
        for socket in (self.inputs + self.outputs):
            if socket.hasEdge():
                socket.edge.remove()
        self.scene.grScene.removeItem(self.grNode)
        self.grNode = None
        self.scene.removeNode(self)

    def serialize(self):
        inputs, outputs = [], []
        for socket in self.inputs:
            inputs.append(socket.serialize())
        for socket in self.outputs:
            outputs.append(socket.serialize())
        return OrderedDict([
            ('id', self.id),
            ('title', self.title),
            ('node_type', self.node_type),
            ('type', self.type),
            ('pos_x', self.grNode.scenePos().x()),
            ('pos_y', self.grNode.scenePos().y()),
            ('inputs', inputs),
            ('outputs', outputs),
        ])

    def deserialize(self, data, hashmap={}):

        self.id = data['id']
        self.node_type = data['node_type']
        hashmap[data['id']] = self
        self.type = data['type']
        self.setPos(data['pos_x'], data['pos_y'])
        self.title = data['title']

        data['inputs'].sort(key=lambda socket: socket['index'] + socket['position'] * 1000)
        data['outputs'].sort(key=lambda socket: socket['index'] + socket['position'] * 1000)
        self.inputs = []
        for socket_data in data['inputs']:
            new_socket = Socket(node=self, index=socket_data['index'], position=socket_data['position'],
                                socket_type=socket_data['socket_type'])

            new_socket.deserialize(socket_data, hashmap)
            self.inputs.append(new_socket)

        self.outputs = []
        for socket_data in data['outputs']:
            new_socket = Socket(node=self, index=socket_data['index'], position=socket_data['position'],
                                socket_type=socket_data['socket_type'])

            new_socket.deserialize(socket_data, hashmap)
            self.outputs.append(new_socket)
        return True

    @property
    def title(self):
        return self._title

    @title.setter
    def title(self, value):
        self._title = value
        self.grNode.title = self._title
